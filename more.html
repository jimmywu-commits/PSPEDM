<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>更多精選商品｜自動套版</title>

<!-- 已移除 Google Noto Sans TC 相關 link -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">

<style>
  /* 本機同層字型：./#勿動資料夾/字體/ShopeeNotoSans(content)-*.ttf */
  @font-face{
    font-family:"SN-Bold";
    src:url("./%23勿動資料夾/字體/ShopeeNotoSans(content)-Bold.ttf") format("truetype");
    font-weight:700;font-style:normal;font-display:swap;
  }
  @font-face{
    font-family:"SN-Medium";
    src:url("./%23勿動資料夾/字體/ShopeeNotoSans(content)-Medium.ttf") format("truetype");
    font-weight:500;font-style:normal;font-display:swap;
  }
  @font-face{
    font-family:"SN-Regular";
    src:url("./%23勿動資料夾/字體/ShopeeNotoSans(content)-Regular.ttf") format("truetype");
    font-weight:400;font-style:normal;font-display:swap;
  }

  :root{
    --bg:#ffbd83; --accent:#ff6b45; --text:#2b1908; --highlight:#e3342f;
    --border:#ffbd83; --gap:9px; --img-height:280px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    /* 強制只吃同層 SN 字型，最後留 generic sans-serif 避免整頁沒字 */
    font-family:"SN-Regular","SN-Medium","SN-Bold",sans-serif;
    color:var(--text);
    background:#fff6ef;
  }
  header{max-width:1200px;margin:24px auto 8px;padding:0 16px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
  header h1{margin:0 6px 0 0;font-size:24px;font-weight:900;letter-spacing:.04em;}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  .btn{background:#222;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700;font-size:12pt;}
  .btn.secondary{background:#eee;color:#333}
  .input{height:38px;border-radius:10px;border:1px solid #ddd;padding:0 12px;outline:none;}
  .wrap{max-width:1200px;margin:10px auto 40px;padding:0 16px;transition:max-width .2s ease;}
  .wrap.capture-pad{padding-bottom:10px;}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap);}
  @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:580px){.grid{grid-template-columns:1fr;}}
  .card{background:#fff;border:7px solid var(--border);overflow:hidden;position:relative;}
  .thumb{position:relative;padding:14px;min-height:calc(var(--img-height) + 60px);display:flex;align-items:center;justify-content:center;background:#fff;}
  .thumb img{max-width:100%;max-height:var(--img-height);object-fit:contain;display:block;}
  .thumb img:not([src]){display:none;}
  .thumb .ph{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#bbb;font-size:18px;user-select:none;pointer-events:none;}
  .play{position:absolute;right:16px;bottom:-22px;width:44px;height:44px;border-radius:50%;background:var(--accent);display:grid;place-items:center;color:#fff;box-shadow:0 4px 10px rgba(255,107,69,.35);}
  .meta{background:var(--bg);text-align:center;padding:20px 0;}

  .brand{
    /* 僅指定 SN 字體，不再列出 Noto / 微軟正黑 / 系統字 */
    font-family:"SN-Bold","SN-Medium","SN-Regular",sans-serif;
    font-size:24px;
    font-weight:700;
    letter-spacing:.06em;
    margin:0 0 0px; /* 品名-文案距離 0px */
  }

  .share{
    /* 僅指定 SN 字體 */
    font-family:"SN-Medium","SN-Regular","SN-Bold",sans-serif;
    margin:0;
    font-size:24px;
    font-weight:500;
    color:var(--highlight);
    letter-spacing:.06em;
    white-space:pre-wrap;
  }

  .toolbar{position:absolute;left:10px;top:10px;display:flex;gap:6px;background:rgba(255,255,255,.85);padding:6px;border-radius:10px;border:1px solid #e5e5e5;}
  .mini{font-size:12px;padding:4px 8px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;}
  .mini.warn{border-color:#ffcfb8;background:#fff2ec;}
  .hidden{display:none;}
  body.capturing header,body.capturing .toolbar{display:none!important;}
  body.capturing [contenteditable]{outline:none;}
  .toast{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px;}
  .toast .msg{background:#111;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.15);font-size:14px;display:flex;align-items:center;gap:8px;opacity:.98;}
  .msg.ok{background:#13a10e;} .msg.err{background:#c72c41;} .msg.load{background:#333;}
  .msg .spin{width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:sp 1s linear infinite;}
  @keyframes sp{to{transform:rotate(360deg);} }
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9998;}
  .modal.open{display:flex;}
  .modal .panel{width:min(90vw,900px);background:#fff;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;}
  .modal header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;margin:0;}
  .modal .body{padding:10px;}
  .modal .actions{display:flex;gap:8px;padding:10px;justify-content:flex-end;}
  .modal img{max-width:100%;max-height:65vh;display:block;margin:0 auto;}
  #sheetUrl, #loadGSheet{display:none!important;}
  .invisible-import{display:none !important;}

  /* === Jimmy: 隱藏指定工具列按鈕 === */
  #toggleEdit, #downloadToFolder, #clearAll{display:none!important;}
</style>
</head>
<body>
  <header>
    <h1>更多精選商品</h1>
    <div class="controls">

      <label class="btn secondary invisible-import">
        選擇「圖片資料夾」
        <input id="pickFolder" type="file" webkitdirectory directory multiple accept="image/*" style="display:none" />
      </label>

      <label class="btn secondary invisible-import">
        載入工單（.xlsx/.csv）
        <input id="pickSheet" type="file" accept=".xlsx,.xls,.csv" style="display:none" />
      </label>

      <!-- 雲端工單（保留隱藏） -->
      <input id="sheetUrl" class="input" style="min-width:280px" placeholder="貼上 Google 試算表網址（公開可讀或發佈為 CSV）" />
      <button id="loadGSheet" class="btn secondary">載入雲端工單</button>

      <button id="toggleEdit" class="btn">編輯模式：開</button>

      <label class="btn secondary" style="display:flex;align-items:center;gap:6px">
        寬度
        <input id="widthPx" class="input" type="number" min="600" step="10" value="1200" style="width:90px" />
      </label>

      <label class="btn secondary" style="display:flex;align-items:center;gap:6px">
        格數
        <input id="slotCount" class="input" type="number" min="3" step="3" value="27" style="width:80px" />
      </label>

      <label class="btn secondary" style="display:flex;align-items:center;gap:6px">
        圖片高
        <input id="imgHeight" class="input" type="number" min="100" step="10" value="280" style="width:80px" />
      </label>
    

      <button id="downloadToFolder" class="btn">下載到資料夾</button> 
		  <button id="autoLoad" class="btn">上傳工單</button>

      <button id="saveDraft" class="btn secondary">下載編輯檔</button>
      <label class="btn secondary">
        讀取編輯檔
        <input id="loadDraft" type="file" accept=".json" style="display:none" />
      </label>
      <label class="btn secondary">
        上傳反修工單
        <input id="pickReworkSheet" type="file" accept=".xlsx,.xls,.csv" style="display:none" />
      </label>
      <button id="clearAll" class="btn secondary">清除內容</button>
		      <button id="downloadJPG" class="btn">下載 JPG</button>

    </div>
  </header>

  <div id="canvasWrap" class="wrap">
    <div id="grid" class="grid"></div>
  </div>

  <div id="toast" class="toast" aria-live="polite"></div>

  <div id="editModal" class="modal">
    <div class="panel">
      <header>
        <strong>圖片裁切</strong>
        <button id="modalClose" class="btn secondary">關閉</button>
      </header>
      <div class="body"><img id="editImg" alt="裁切" /></div>
      <div class="actions"><button id="applyEdit" class="btn">套用</button></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>

  <script>
    /* === 頁面名稱 === */
    const PAGE_NAME = (document.querySelector('h1')?.textContent || '更多精選商品').trim();
    const PAGE_NAME_NORM = PAGE_NAME.replace(/\s+/g,'').toLowerCase();

    /* ===== 全域狀態 ===== */
    let editMode = true;
    let slotCount = 27;
    let imgHeight = 280;
    // rowsByIndex 內部格式：{ item: 主標, imgKey: 圖片對應鍵(主標下方那格), copy: 紅字文案(圖片名稱下方那格) }
    const state = { images: [], rowsByIndex: [], original: {} };
    // 若已載入編輯檔(JSON)，則鎖住已存在的圖片編輯成果：之後匯入工單(XLSX/CSV)只更新文字，不覆蓋圖片
    let lockEditedImages = false;

    const grid = document.getElementById('grid');
    const wrap = document.getElementById('canvasWrap');
    const toast = document.getElementById('toast');

    /* ===== Toast ===== */
    function showToast(text, type='ok', ms=1800){
      const el = document.createElement('div');
      el.className = `msg ${type}`;
      el.innerHTML = type==='load' ? `<span class="spin"></span>${text}` : text;
      toast.appendChild(el);
      if(type !== 'load'){ setTimeout(()=> el.remove(), ms); }
      return el;
    }

    /* ===== 檢查同層字型是否有成功載入 ===== */
    function checkCustomFontsLoaded(){
      // 部分舊瀏覽器沒有 document.fonts，就直接跳過檢查
      if (!document.fonts || !document.fonts.check) return;

      const hasBold    = document.fonts.check('700 16px "SN-Bold"');
      const hasMedium  = document.fonts.check('500 16px "SN-Medium"');
      const hasRegular = document.fonts.check('400 16px "SN-Regular"');

      if (!(hasBold && hasMedium && hasRegular)){
        showToast(
          '⚠️ ShopeeNotoSans 字型未成功載入，請確認同層「#勿動資料夾/字體」內 SN-Bold / SN-Medium / SN-Regular 是否存在，且路徑與檔名正確。',
          'err',
          6000
        );
      }
    }

    if (document.fonts && document.fonts.ready){
      document.fonts.ready.then(checkCustomFontsLoaded);
    } else {
      window.addEventListener('load', checkCustomFontsLoaded);
    }

    /* ===== 檔名去副檔名（比對用） ===== */
    function fileBaseName(name){ return name.replace(/\.[^.]+$/,'').trim(); }

    /* ===== 自動暫存：LocalStorage ===== */
    const AUTO_KEY = 'edm_autosave_v8';
    function captureDraftFromDOM(){
      const cards = [...grid.children];
      return {
        meta: { slotCount, width: wrap.style.maxWidth || '1200px', imgHeight, page: PAGE_NAME, version: 8, ts: Date.now() },
        items: cards.map(card=>{
          const img   = card.querySelector('img');
          const brand = card.querySelector('.brand').textContent;
          const share = card.querySelector('.share').textContent;
          const src   = img.getAttribute('src') || '';
          return { img: src, brand, share };
        })
      };
    }
    function saveAuto(){ try{ localStorage.setItem(AUTO_KEY, JSON.stringify(captureDraftFromDOM())); }catch(e){} }
    const saveAutoDebounced = (()=>{
      let t; return ()=>{ clearTimeout(t); t=setTimeout(saveAuto, 300); };
    })();
    function loadAuto(){
      try{
        const raw = localStorage.getItem(AUTO_KEY);
        if(!raw) return false;
        const data = JSON.parse(raw);
        if(data?.meta?.page && data.meta.page !== PAGE_NAME){
          showToast(`已載入其他頁的暫存（${data.meta.page}）`,'load',1400);
        }
        slotCount = Number(data?.meta?.slotCount || slotCount);
        imgHeight = Number(data?.meta?.imgHeight || imgHeight);
        document.getElementById('slotCount').value = slotCount;
        document.getElementById('imgHeight').value = imgHeight;
        document.documentElement.style.setProperty('--img-height', imgHeight+'px');
        wrap.style.maxWidth = data?.meta?.width || wrap.style.maxWidth;

        adjustGridSize(slotCount);
        (data.items||[]).forEach((it,i)=>{
          const card = grid.children[i];
          if(!card) return;
          const img   = card.querySelector('img');
          const ph    = card.querySelector('.ph');
          const brand = card.querySelector('.brand');
          const share = card.querySelector('.share');
          if(it.img){ img.src = it.img; ph.style.display='none'; } else { img.removeAttribute('src'); ph.style.display='flex'; }
          brand.textContent = it.brand || '';
          share.textContent = it.share || '';
        });
        return true;
      }catch(e){ return false; }
    }

    /* ===== 工單解析 ===== */
    function rowsFromGridPattern(arr){
      const out = [];
      let group = 0;
      while (true){
        const nameRow = 1 + 3*group;
        const imgRow  = 2 + 3*group;
        const copyRow = 3 + 3*group;

        const nIdx = nameRow - 1, iIdx = imgRow - 1, cIdx = copyRow - 1;
        if (nIdx >= arr.length && iIdx >= arr.length && cIdx >= arr.length) break;

        const names  = arr[nIdx] || [];
        const imgK   = arr[iIdx] || [];
        const copies = arr[cIdx] || [];

        const items = [];
        for (let col=0; col<3; col++){
          const item  = (names[col]  ?? '').toString().trim();
          const imgKey= (imgK[col]   ?? '').toString().trim();
          const copy  = (copies[col] ?? '').toString().trim();
          items.push({ item, imgKey, copy });
        }

        const any = items.some(it => it.item || it.imgKey || it.copy);
        if (!any) break;

        out.push(...items);
        group++;
      }
      while (out.length && !out[out.length-1].item && !out[out.length-1].imgKey && !out[out.length-1].copy){
        out.pop();
      }
      return out;
    }

    /* ===== 建卡 / 調整格數 ===== */
    function createCard({url, item='', c1='', idx}) {
      const card = document.createElement('article');
      card.className = 'card';
      card.dataset.idx = idx;

      card.innerHTML = `
        <div class="thumb">
          <div class="toolbar ${editMode?'':'hidden'}">
            <button class="mini crop">裁切</button>
            <button class="mini change">換圖</button>
            <button class="mini warn revert">還原</button>
          </div>
          <div class="ph">圖片 ${idx+1}</div>
          <img alt="">
          <div class="play"><span class="tri">▶</span></div>
          <input type="file" accept="image/*" class="hidden picker" />
        </div>
        <div class="meta">
          <p class="brand" ${editMode?'contenteditable':''}></p>
          <p class="share" ${editMode?'contenteditable':''}></p>
        </div>
      `;

      const img = card.querySelector('img');
      const ph  = card.querySelector('.ph');
      const brand = card.querySelector('.brand');
      const share = card.querySelector('.share');
      const picker = card.querySelector('.picker');

      if(url){ img.src = url; ph.style.display='none'; }
      brand.textContent = item || '';
      share.textContent = c1 || '';

      // 初始狀態記錄（給「還原」用）
      state.original[idx] = { url: url || '', brand: brand.textContent, share: share.textContent };

      card.querySelector('.change').addEventListener('click', ()=> picker.click());
      picker.addEventListener('change', e=>{
        const f = e.target.files?.[0]; if(!f) return;
        img.src = URL.createObjectURL(f);
        ph.style.display = 'none';
        saveAutoDebounced();
      });

      card.querySelector('.crop').addEventListener('click', ()=>{
        if(!img.getAttribute('src')){ showToast('請先選一張圖片','err'); return; }
        openCropper(img);
      });

      card.querySelector('.revert').addEventListener('click', ()=>{
        const o = state.original[idx]||{};
        if(o.url){ img.src = o.url; ph.style.display='none'; }
        else { img.removeAttribute('src'); ph.style.display='flex'; }
        brand.textContent = o.brand??'';
        share.textContent = o.share??'';
        saveAutoDebounced();
      });

      return card;
    }
    function appendCard(i){
      const row = state.rowsByIndex[i] || { item:'', imgKey:'', copy:'' };
      grid.appendChild(createCard({ url:'', item: row.item, c1: row.copy, idx: i }));
    }
    function adjustGridSize(newCount){
      const current = grid.children.length;
      if(newCount > current){
        for(let i=current;i<newCount;i++) appendCard(i);
      }else if(newCount < current){
        for(let i=current-1;i>=newCount;i--) grid.removeChild(grid.children[i]);
      }
      slotCount = newCount;
    }
    function applyRowsToDOM(){
      [...grid.children].forEach((card,i)=>{
        const row = state.rowsByIndex[i] || { item:'', imgKey:'', copy:'' };
        card.querySelector('.brand').textContent = row.item || '';
        card.querySelector('.share').textContent = row.copy || '';
      });
      saveAutoDebounced();
    }
    function setEditModeUI(){
      [...grid.children].forEach(card=>{
        const tb = card.querySelector('.toolbar');
        const brand = card.querySelector('.brand');
        const share = card.querySelector('.share');
        tb.classList.toggle('hidden', !editMode);
        brand.toggleAttribute('contenteditable', editMode);
        share.toggleAttribute('contenteditable', editMode);
      });
    }

    /* ===== JPG 匯出（每 3 排一張） ===== */
    async function captureJPGByPages(){
      const desired = Math.max(600, Number(document.getElementById('widthPx').value||1200));
      const cols = 3, rowsPerPage = 3, perPage = cols * rowsPerPage;
      const cards = [...grid.children]; const total = cards.length;
      if (!total){ showToast('沒有可下載的內容','err'); return; }

      const cs   = getComputedStyle(wrap);
      const padL = parseInt(cs.paddingLeft)  || 0;
      const padR = parseInt(cs.paddingRight) || 0;
      const padT = parseInt(cs.paddingTop)   || 0;
      const padB = padL;

      document.body.classList.add('capturing');
      wrap.classList.add('capture-pad');

      let pageNo = 1;
      for (let start = 0; start < total; start += perPage, pageNo++){
        const end = Math.min(start + perPage, total);

        const clone = wrap.cloneNode(true);
        clone.style.maxWidth      = desired + 'px';
        clone.style.width         = desired + 'px';
        clone.style.paddingTop    = padT + 'px';
        clone.style.paddingLeft   = padL + 'px';
        clone.style.paddingRight  = padR + 'px';
        clone.style.paddingBottom = (padB + 10) + 'px';
        clone.style.position = 'fixed';
        clone.style.left = '-99999px';
        clone.style.top  = '0';
        document.body.appendChild(clone);

        const gridClone = clone.querySelector('.grid');
        gridClone.innerHTML = '';
        for (let i = start; i < end; i++){
          gridClone.appendChild(cards[i].cloneNode(true));
        }
        gridClone.style.gridTemplateColumns = 'repeat(3, 1fr)';

        const canvas = await html2canvas(clone, { useCORS:true, backgroundColor:'#fff', scale:1 });

        const a = document.createElement('a');
        a.download = `更多精選商品_${pageNo}.jpg`;
        a.href = canvas.toDataURL('image/jpeg', 0.95);
        a.click();

        clone.remove();
      }

      wrap.classList.remove('capture-pad');
      document.body.classList.remove('capturing');
      showToast(`已下載 ${Math.ceil(total/perPage)} 張 JPG`,'ok');
    }

    async function renderPageToBlob({cards, start, end, desired, padT, padL, padR, padB}){
      const clone = wrap.cloneNode(true);
      clone.style.maxWidth      = desired + 'px';
      clone.style.width         = desired + 'px';
      clone.style.paddingTop    = padT + 'px';
      clone.style.paddingLeft   = padL + 'px';
      clone.style.paddingRight  = padR + 'px';
      clone.style.paddingBottom = (padB + 10) + 'px';
      clone.style.position = 'fixed';
      clone.style.left = '-99999px';
      clone.style.top  = '0';
      document.body.appendChild(clone);

      const gridClone = clone.querySelector('.grid');
      gridClone.innerHTML = '';
      for (let i = start; i < end; i++){
        gridClone.appendChild(cards[i].cloneNode(true));
      }
      gridClone.style.gridTemplateColumns = 'repeat(3, 1fr)';

      const canvas = await html2canvas(clone, { useCORS:true, backgroundColor:'#fff', scale:1 });
      clone.remove();

      const blob = await new Promise(resolve=>{
        try { canvas.toBlob(b=>resolve(b),'image/jpeg',0.95); }
        catch { resolve(null); }
      });
      if (blob) return blob;

      const dataURL = canvas.toDataURL('image/jpeg', 0.95);
      const byteString = atob(dataURL.split(',')[1]);
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      for (let i=0;i<byteString.length;i++) ia[i] = byteString.charCodeAt(i);
      return new Blob([ab], {type:'image/jpeg'});
    }

    /* ===== 下載到資料夾（逐張另存） ===== */
    async function downloadJPGToFolder(){
      const desired = Math.max(600, Number(document.getElementById('widthPx').value||1200));
      const cols = 3, rowsPerPage = 3, perPage = cols * rowsPerPage;

      const cards = [...grid.children];
      const total = cards.length;
      if (!total){ showToast('沒有可下載的內容','err'); return; }

      const cs   = getComputedStyle(wrap);
      const padL = parseInt(cs.paddingLeft)  || 0;
      const padR = parseInt(cs.paddingRight) || 0;
      const padT = parseInt(cs.paddingTop)   || 0;
      const padB = padL;

      const hasFSP = 'showSaveFilePicker' in window;

      document.body.classList.add('capturing');
      wrap.classList.add('capture-pad');

      try{
        let pageNo = 1;
        for (let start = 0; start < total; start += perPage, pageNo++){
          const end = Math.min(start + perPage, total);
          const blob = await renderPageToBlob({cards, start, end, desired, padT, padL, padR, padB});
          const suggestedName = `更多精選商品_${pageNo}.jpg`;

          if (hasFSP){
            try{
              const handle = await window.showSaveFilePicker({
                suggestedName,
                types: [{ description:'JPEG Image', accept:{ 'image/jpeg':['.jpg','.jpeg'] } }]
              });
              const writable = await handle.createWritable();
              await writable.write(blob);
              await writable.close();
            }catch(e){
              if(e?.name==='AbortError'){
                showToast('已取消儲存','load',1600);
                break;
              }else{
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.download = suggestedName; a.href = url; a.click();
                URL.revokeObjectURL(url);
              }
            }
          }else{
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.download = suggestedName; a.href = url; a.click();
            URL.revokeObjectURL(url);
          }
        }
        showToast('已完成儲存/下載','ok');
      }catch(err){
        console.error(err);
        showToast('發生錯誤，改用預設下載','load',1600);
        await captureJPGByPages();
      }finally{
        wrap.classList.remove('capture-pad');
        document.body.classList.remove('capturing');
      }
    }

    /* ===== 裁切彈窗 ===== */
    let cropper = null, targetImgElem = null;
    const modal = document.getElementById('editModal');
    const editImg = document.getElementById('editImg');

    function openCropper(imgElem){
      targetImgElem = imgElem;
      editImg.src = imgElem.src || '';
      modal.classList.add('open');
      cropper?.destroy?.();
      cropper = new Cropper(editImg, { viewMode:1, autoCropArea:1, movable:true, zoomable:true, scalable:true });
    }
    document.getElementById('applyEdit').addEventListener('click', ()=>{
      if(!targetImgElem || !cropper) return;
      const dataUrl = cropper.getCroppedCanvas().toDataURL('image/png');
      targetImgElem.src = dataUrl;
      const card = targetImgElem.closest('.card');
      card.querySelector('.ph').style.display='none';
      cropper.destroy();
      modal.classList.remove('open');
      showToast('裁切完成','ok');
      saveAutoDebounced();
    });
    document.getElementById('modalClose').addEventListener('click', ()=>{
      cropper?.destroy?.();
      modal.classList.remove('open');
    });

    /* ===== 讀工單（本機 / 雲端） ===== */
    async function handleSheetFile(file){
      try{
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });

        const exact = wb.SheetNames.find(n => n.trim() === PAGE_NAME);
        const loose = wb.SheetNames.find(n => n.trim().replace(/\s+/g,'').toLowerCase() === PAGE_NAME_NORM);
        const pickedName = exact || loose || wb.SheetNames[0];

        const ws = wb.Sheets[pickedName];
        const arr = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        state.rowsByIndex = rowsFromGridPattern(arr);

        const countFromSheet  = state.rowsByIndex.length;

        // 若已載入 JSON 編輯檔，工單匯入「只更新文字」，不縮減格數以免誤刪/覆蓋已編輯圖片
        if (!lockEditedImages){
          if (countFromSheet !== slotCount){
            slotCount = countFromSheet;
            document.getElementById('slotCount').value = slotCount;
            adjustGridSize(slotCount);
          }
        }else{
          // 只允許增加格數（新增格會是空圖），不允許縮減格數
          if (countFromSheet > slotCount){
            slotCount = countFromSheet;
            document.getElementById('slotCount').value = slotCount;
            adjustGridSize(slotCount);
          }
        }
        applyRowsToDOM();
        showToast(`本機工單載入成功（使用頁籤：${pickedName}）`,'ok');
        saveAutoDebounced();
      }catch(e){ showToast('本機工單載入失敗','err'); }
    }

    function parseGSheetUrl(u){
      try{
        const url = new URL(u.trim());
        if(!/docs\.google\.com\/spreadsheets/.test(url.hostname + url.pathname)) return null;
        const id = url.pathname.match(/\/spreadsheets\/d\/([^\/]+)/)?.[1];
        const gidFromQuery = url.searchParams.get('gid');
        const gidFromHash  = url.hash.match(/gid=(\d+)/)?.[1];
        const gid = gidFromQuery || gidFromHash || '0';
        if(!id) return null;
        return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&id=${id}&gid=${gid}`;
      }catch{ return null; }
    }
    async function handleGSheetUrl(inputUrl){
      const csvUrl = parseGSheetUrl(inputUrl);
      if(!csvUrl){ showToast('請貼 Google 試算表網址','err'); return; }
      const loading = showToast('讀取雲端工單中…','load');
      try{
        const res = await fetch(csvUrl);
        if(!res.ok) throw new Error('權限或連線錯誤');
        const text = await res.text();
        const wb = XLSX.read(text, { type: 'string' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const arr = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        state.rowsByIndex = rowsFromGridPattern(arr);

        const countFromSheet  = state.rowsByIndex.length;

        // 若已載入 JSON 編輯檔，工單匯入「只更新文字」，不縮減格數以免誤刪/覆蓋已編輯圖片
        if (!lockEditedImages){
          if (countFromSheet !== slotCount){
            slotCount = countFromSheet;
            document.getElementById('slotCount').value = slotCount;
            adjustGridSize(slotCount);
          }
        }else{
          // 只允許增加格數（新增格會是空圖），不允許縮減格數
          if (countFromSheet > slotCount){
            slotCount = countFromSheet;
            document.getElementById('slotCount').value = slotCount;
            adjustGridSize(slotCount);
          }
        }
        applyRowsToDOM();
        loading.remove();
        showToast(`雲端工單載入成功（請確認分頁 =「${PAGE_NAME}」）`,'ok');
        saveAutoDebounced();
      }catch(e){
        loading.remove();
        showToast('雲端工單載入失敗（請確認權限或改用發佈為 CSV）','err');
      }
    }

    /* ===== 圖片載入規則 ===== */
    async function handleFolderFiles(fileList){
      const files = [...fileList].filter(f=> f.type.startsWith('image/'));
      if (!files.length){
        showToast('沒有可用的圖片','err');
        return;
      }

      const nameToUrl = new Map();
      const duplicateNames = new Set();
      for (const f of files){
        const key = fileBaseName(f.name);
        const url = URL.createObjectURL(f);
        if (nameToUrl.has(key)){
          duplicateNames.add(key);
        }else{
          nameToUrl.set(key, url);
        }
      }

      let hit = 0;
      const misses = [];

      [...grid.children].forEach((card,i)=>{
        const row = state.rowsByIndex[i] || { item:'', imgKey:'', copy:'' };
        const expectedFileBase = row.imgKey.trim();
        const img = card.querySelector('img');
        const ph  = card.querySelector('.ph');

        if (expectedFileBase && nameToUrl.has(expectedFileBase)){
          // 若已載入 JSON 編輯檔：只填「空的圖片格」，不要覆蓋已存在（可能已裁切/編輯）的圖片
          const hasImg = !!img.getAttribute('src');
          if (!lockEditedImages || !hasImg){
            img.src = nameToUrl.get(expectedFileBase);
            ph.style.display = 'none';
            hit++;
          }
        }else{
          if(!img.getAttribute('src')){
            img.removeAttribute('src');
            ph.style.display = 'flex';
          }
          misses.push(expectedFileBase || `#${i+1}`);
        }
      });

      showToast(`已匹配 ${hit} 張（依主標下方檔名）`,'ok');
      if (duplicateNames.size){
        showToast(`偵測到重複檔名（只採第一個）：${[...duplicateNames].slice(0,5).join('、')}${duplicateNames.size>5?'…':''}`,'load',2600);
      }
      if (misses.length){
        showToast(`未找到對應圖片：${misses.slice(0,6).join('、')}${misses.length>6?'…':''}`,'load',2600);
      }

      saveAutoDebounced();
    }


    /* ===== 自動載入（同層） ===== */
    async function autoLoad(){
      if(!('showDirectoryPicker' in window)){ showToast('瀏覽器不支援同層自動讀取','err'); return; }
      try{
        const root = await window.showDirectoryPicker();

        let sheetHandle = null;
        const candidates = [];
        for await (const [name, handle] of root.entries()){
          if(handle.kind==='file' && /\.(xlsx|xls|csv)$/i.test(name)){
            candidates.push({name, handle});
          }
        }
        if(candidates.length){
          candidates.sort((a,b)=>{
            const aHit = a.name.toLowerCase().includes(PAGE_NAME_NORM) ? 0 : 1;
            const bHit = b.name.toLowerCase().includes(PAGE_NAME_NORM) ? 0 : 1;
            return aHit - bHit || a.name.localeCompare(b.name,'zh-Hant');
          });
          sheetHandle = candidates[0].handle;
          const f = await sheetHandle.getFile();
          await handleSheetFile(f);
        }else{
          showToast('未找到工單檔（.xlsx/.csv）','load',1600);
        }

        let imgFolder = null;
        for await (const [name, handle] of root.entries()){
          if(handle.kind==='directory'){
            const norm = name.replace(/\s+/g,'').toLowerCase();
            if(norm === PAGE_NAME_NORM){ imgFolder = handle; break; }
          }
        }
        if(!imgFolder){
          showToast(`找不到同名資料夾「${PAGE_NAME}」`,'err');
        }else{
          const imgs = [];
          for await (const [, h] of imgFolder.entries()){
            if(h.kind==='file'){
              const f = await h.getFile();
              if(f.type.startsWith('image/')) imgs.push(f);
            }
          }
          await handleFolderFiles(imgs);
        }

        showToast('自動載入完成','ok');
        saveAutoDebounced();
      }catch(e){
        if(e?.name!=='AbortError') showToast('自動載入失敗','err');
      }
    }

    /* ===== 暫存 / 讀取暫存 / 清除 ===== */
    async function imageToDataURL(src){
      if(!src) return '';
      if(/^data:/.test(src)) return src; // 已經是 DataURL
      return new Promise(resolve=>{
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = ()=>{
          const c = document.createElement('canvas');
          c.width = img.width; c.height = img.height;
          const ctx = c.getContext('2d');
          ctx.drawImage(img,0,0);
          resolve(c.toDataURL('image/png'));
        };
        img.onerror = ()=> resolve('');
        img.src = src;
      });
    }

    // 下載編輯檔：使用 DataURL 內嵌圖片（方案 A）
    async function saveDraft(){
      const cards = [...grid.children];
      const items = [];
      let idx = 0;
      for (const card of cards){
        const img = card.querySelector('img');
        const brand = card.querySelector('.brand').textContent;
        const share = card.querySelector('.share').textContent;
        const src = img.getAttribute('src') || '';
        const dataUrl = await imageToDataURL(src);  // 這裡確保裁切後 / 外部圖都被轉成 DataURL 存進 JSON
        items.push({ img: dataUrl, brand, share });

        // 也同步更新 original，讓載入後「還原」是回到編輯檔初始狀態
        state.original[idx] = { url: dataUrl || '', brand, share };
        idx++;
      }
      const blob = new Blob([JSON.stringify({
        meta:{ slotCount, width: wrap.style.maxWidth || '1200px', imgHeight, page: PAGE_NAME, version:8 },
        items
      })], {type:'application/json'});
      const a = document.createElement('a');
      a.download = 'edm_draft.json';
      a.href = URL.createObjectURL(blob);
      a.click();
      showToast('已下載暫存檔（內含圖片 DataURL）','ok');
    }

    // 載入編輯檔：直接吃 DataURL，並更新 original
    function loadDraft(file){
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const data = JSON.parse(r.result);
          slotCount = Number(data?.meta?.slotCount || 27);
          imgHeight = Number(data?.meta?.imgHeight || 280);
          document.getElementById('slotCount').value = slotCount;
          document.getElementById('imgHeight').value = imgHeight;
          document.documentElement.style.setProperty('--img-height', imgHeight+'px');
          wrap.style.maxWidth = data?.meta?.width || '1200px';

          adjustGridSize(slotCount);
          state.original = {}; // 重建 original，對齊載入的內容

          (data.items||[]).forEach((it,i)=>{
            const card = grid.children[i];
            if(!card) return;
            const img   = card.querySelector('img');
            const ph    = card.querySelector('.ph');
            const brand = card.querySelector('.brand');
            const share = card.querySelector('.share');
            if(it.img){ img.src = it.img; ph.style.display='none'; } else { img.removeAttribute('src'); ph.style.display='flex'; }
            brand.textContent = it.brand || '';
            share.textContent = it.share || '';

            // 以 JSON 裡的狀態當作「還原」基準
            state.original[i] = {
              url: it.img || '',
              brand: it.brand || '',
              share: it.share || ''
            };
          });
          showToast('暫存已載入（含圖片 DataURL）','ok');
          lockEditedImages = true; // 鎖住圖片編輯成果，避免後續匯入工單/圖片時覆蓋
          saveAutoDebounced();
        }catch(e){ 
          console.error(e);
          showToast('暫存檔格式錯誤','err'); 
        }
      };
      r.readAsText(file);
    }

    function clearAll(){
      if(!confirm('確定要清除內容嗎？這會移除所有圖片與文字，並清除自動暫存。')) return;
      [...grid.children].forEach(card=>{
        const img = card.querySelector('img');
        const ph  = card.querySelector('.ph');
        const brand = card.querySelector('.brand');
        const share = card.querySelector('.share');
        img.removeAttribute('src');
        ph.style.display = 'flex';
        brand.textContent = '';
        share.textContent = '';
      });
      state.images = [];
      state.rowsByIndex = [];
      state.original = {};
      try{ localStorage.removeItem(AUTO_KEY); }catch(e){}
      showToast('內容已清除','ok');
      lockEditedImages = false;
    }

    /* ===== 事件綁定 ===== */
    document.getElementById('autoLoad').addEventListener('click', autoLoad);
    document.getElementById('pickFolder').addEventListener('change', e=> e.target.files.length && handleFolderFiles(e.target.files));
    document.getElementById('pickSheet').addEventListener('change', e=> e.target.files[0] && handleSheetFile(e.target.files[0]));
    document.getElementById('pickReworkSheet').addEventListener('change', async e=>{
      if(!e.target.files[0]) return;
      // 反修工單：只更新文字，不動圖片/裁切成果；同時避免縮減格數誤刪已編輯內容
      const prevLock = lockEditedImages;
      lockEditedImages = true;
      await handleSheetFile(e.target.files[0]);
      lockEditedImages = prevLock;
      showToast('反修工單文字已更新（圖片不變）','ok');
      e.target.value='';
    });
    document.getElementById('loadGSheet').addEventListener('click', ()=>{
      const u = document.getElementById('sheetUrl').value.trim();
      if(u) handleGSheetUrl(u); else showToast('請先貼上 Google 試算表網址','err');
    });

    document.getElementById('toggleEdit').addEventListener('click', ()=>{
      editMode = !editMode;
      document.getElementById('toggleEdit').textContent = `編輯模式：${editMode?'開':'關'}`;
      setEditModeUI();
      saveAutoDebounced();
    });
    document.getElementById('widthPx').addEventListener('input', e=>{
      const v = Math.max(600, Number(e.target.value||1200));
      wrap.style.maxWidth = v + 'px';
      saveAutoDebounced();
    });
    document.getElementById('slotCount').addEventListener('input', e=>{
      const v = Math.max(3, Math.floor(Number(e.target.value||27)/3)*3);
      e.target.value = v;
      adjustGridSize(v);
      setEditModeUI();
      saveAutoDebounced();
    });
    document.getElementById('imgHeight').addEventListener('input', e=>{
      imgHeight = Math.max(100, Number(e.target.value||280));
      document.documentElement.style.setProperty('--img-height', imgHeight+'px');
      saveAutoDebounced();
    });

    document.getElementById('downloadJPG').addEventListener('click', captureJPGByPages);
    document.getElementById('downloadToFolder').addEventListener('click', downloadJPGToFolder);

    document.getElementById('saveDraft').addEventListener('click', saveDraft);
    document.getElementById('loadDraft').addEventListener('change', e=> e.target.files[0] && loadDraft(e.target.files[0]));
    document.getElementById('clearAll').addEventListener('click', clearAll);

    grid.addEventListener('input', e=>{
      if(e.target.matches('.brand, .share')) saveAutoDebounced();
    });

    window.addEventListener('dragover', e=> e.preventDefault());
    window.addEventListener('drop', e=>{
      e.preventDefault();
      const files = [...e.dataTransfer.files];
      const imgs = files.filter(f=> f.type.startsWith('image/'));
      const sheet = files.find(f=> /\.(xlsx|xls|csv)$/i.test(f.name));
      if(sheet) handleSheetFile(sheet);
      if(imgs.length) handleFolderFiles(imgs);
    });

    wrap.style.maxWidth = '1200px';
    adjustGridSize(slotCount);
    document.documentElement.style.setProperty('--img-height', imgHeight+'px');
    loadAuto();
    setEditModeUI();
  </script>
</body>
</html>
